# Service Management

Create and manage services for a Bedrock project.

Usage:

```
spk service [command] [options]
```

Commands:

- [Service Management](#service-management)
  - [Prerequisites](#prerequisites)
  - [Commands](#commands)
    - [create](#create)
    - [create-pipeline](#create-pipeline)
    - [create-revision](#create-revision)
    - [create-variable-group](#create-variable-group)

Global options:

```
  -v, --verbose        Enable verbose logging
  -h, --help           Usage information
```

## Prerequisites

An existing
[Azure DevOps project](https://azure.microsoft.com/en-us/services/devops/) is
required to create a Variable Group. In addition, to link secrets from an Azure
key vault as variables in Variable Group, you will need an existing key vault
containing your secrets and the Service Principal for authorization with Azure
Key Vault.

1. Use existng or
   [create a service principal either in Azure Portal](https://docs.microsoft.com/en-us/azure/active-directory/develop/howto-create-service-principal-portal)
   or
   [with Azure CLI](https://docs.microsoft.com/en-us/cli/azure/create-an-azure-service-principal-azure-cli?view=azure-cli-latest).
2. Use existing or
   [create a Key Vault in Azure Portal](https://docs.microsoft.com/en-us/azure/key-vault/quick-create-portal)
   or
   [with Azure CLI](https://docs.microsoft.com/en-us/azure/key-vault/quick-create-cli).
3. Give the service principal `get` and `list` access in Azure Key Vault. Follow
   step 2 from
   [these instructions](https://docs.microsoft.com/en-us/azure/devops/pipelines/library/variable-groups?view=azure-devops&tabs=yaml#link-secrets-from-an-azure-key-vault).

## Commands

### create

Add a new service into this initialized spk project repository

```
Usage: service create|c [options] <service-name>

Add a new service into this initialized spk project repository

Options:
  -c, --helm-chart-chart <helm-chart>            bedrock helm chart name. --helm-chart-* and --helm-config-* are exclusive; you may only use one. (default: "")
  -r, --helm-chart-repository <helm-repository>  bedrock helm chart repository. --helm-chart-* and --helm-config-* are exclusive; you may only use one. (default: "")
  -b, --helm-config-branch <helm-branch>         bedrock custom helm chart configuration branch. --helm-chart-* and --helm-config-* are exclusive; you may only use one. (default: "")
  -p, --helm-config-path <helm-path>             bedrock custom helm chart configuration path. --helm-chart-* and --helm-config-* are exclusive; you may only use one. (default: "")
  -g, --helm-config-git <helm-git>               bedrock helm chart configuration git repository. --helm-chart-* and --helm-config-* are exclusive; you may only use one. (default: "")
  -d, --packages-dir <dir>                       The directory containing the mono-repo packages. (default: "")
  -m, --maintainer-name <maintainer-name>        The name of the primary maintainer for this service. (default: "maintainer name")
  -e, --maintainer-email <maintainer-email>      The email of the primary maintainer for this service. (default: "maintainer email")
  --git-push                                     SPK CLI will try to commit and push these changes to a new origin/branch named after the service. (default: false)
  -h, --help                                     output usage information
```

**NOTE:**

`--helm-chart-*` and `--helm-config-*` settings are exclusive. **You may only
use one.**

### create-pipeline

Configure Azure DevOps for a bedrock managed service. The default pipeline
generated by `spk service create` is a multistage pipeline, which is in public
preview and must be enabled to use.
https://docs.microsoft.com/en-us/azure/devops/pipelines/process/stages?view=azure-devops&tabs=yaml

```
Usage: service create-pipeline|p [options] <service-name>

Configure Azure DevOps for a bedrock managed service.

Options:
  -n, --pipeline-name <pipeline-name>                  Name of the pipeline to be created
  -p, --personal-access-token <personal-access-token>  Personal Access Token
  -o, --org-name <org-name>                            Organization Name for Azure DevOps
  -r, --repo-name <repo-name>                          Repository Name in Azure DevOps
  -u, --repo-url <repo-url>                            Repository URL
  -d, --devops-project <devops-project>                Azure DevOps Project
  -l, --packages-dir <packages-dir>                    The mono-repository directory containing this service definition. ie. '--packages-dir packages' if my-service is located under ./packages/my-service. Omitting this option implies this is a not a mono-repository.
  -h, --help                                           output usage information
```

### create-revision

Generate a PR in Azure DevOps against default ring branches

```
Usage: service create-revision|cr [options]

Create pull requests against the branches marked as `isDefault` in your bedrock config

Options:
  -s, --source-branch <source>     Source branch to create the pull request from; defaults to the current branch
  -t, --title <title>              Title of the pull request; not required
  -d, --description <description>  Description of the pull request; not required
  --remote-url <remote-url>        The remote host to create the pull request in; defaults to the URL for 'origin'
  --personal-access-token <pat>    Personal access token associated with your Azure DevOps token; falls back to azure_devops.access_token in your spk config
  --org-name <organization-name>   Your Azure DevOps organization name; falls back to azure_devops.org in your spk config

  -h, --help                       output usage information
```

### create-variable-group

Create new variable group in Azure DevOps project

```
Usage: service ccreate-variable-group|cvg [options] <variable-group-name>

Create new variable group in Azure DevOps project using the options below. Also sets the azure_devops.variable_grroup item in spk config with the variable group name

Options:
  -r, --registry-name <registry-name>                             The name of the existing Azure Container Registry
  -d, --hld-repo-name <hld-repo-name>                             The high level definition (HLD) git repo name
  -u, --service-principal-id <service-principal-id>               Azure service principal id with `contributor` role in Azure Container Registry"
  -p, --service-principal-password <service-principal-password>   The Azure service principal password
  -t, --tenant                                                    The Azure AD tenant id of service principal
  --org-name <organization-name>                                  Azure DevOps organization name; falls back to azure_devops.org in spk config
  --project <project>                                             Azure DevOps project name; falls back to azure_devops.project in spk config
  --personal-access-token <personal-access-token>                 Azure DevOps Personal access token; falls back to azure_devops.access_token in spk config
  -h, --help                                                      output usage information
```
